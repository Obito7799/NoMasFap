<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Biblioteca personal digital para gestionar y leer tus libros favoritos">
    <title>Biblioteca Personal | Mi Colección Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Agregamos epub.js y sus dependencias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        /* ... (mantener todos los estilos anteriores) ... */
        
        .book-cover {
            width: 100%;
            height: 360px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        /* Estilos adicionales para el visor */
        #viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            z-index: 1002;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- ... (mantener header y estructura principal) ... -->

    <main>
        <div class="container">
            <div class="books-grid">
                <!-- Los libros se cargarán dinámicamente -->
            </div>
        </div>
    </main>

    <div id="bookViewer" class="book-viewer">
        <div class="loading">Cargando libro...</div>
        <div class="close-viewer" onclick="closeViewer()">×</div>
        <div id="viewer"></div>
        <div class="viewer-controls">
            <button onclick="prevPage()">Anterior</button>
            <button onclick="nextPage()">Siguiente</button>
        </div>
    </div>

    <script>
        // Configuración de los libros
        const books = [
            {
                title: "Ragnarok: El camino de un hombre",
                path: "Libros/Ragnarok. El camino de un hombre - Hombres Peligrosos.epub",
                id: "ragnarok"
            },
            {
                title: "Mentalidad de Titán",
                path: "Libros/Mentalidad de Titán.epub",
                id: "titan"
            }
        ];

        let currentBook = null;
        let rendition = null;

        // Función para cargar los libros en la grid
        function loadBooks() {
            const booksGrid = document.querySelector('.books-grid');
            booksGrid.innerHTML = '';

            books.forEach(bookData => {
                const bookCard = createBookCard(bookData);
                booksGrid.appendChild(bookCard);
                
                // Intentar cargar la portada
                loadBookCover(bookData, bookCard);
            });
        }

        function createBookCard(bookData) {
            const card = document.createElement('div');
            card.className = 'book-card';
            card.innerHTML = `
                <div class="book-cover" id="cover-${bookData.id}">
                    <span>📚</span>
                </div>
                <div class="book-info">
                    <h2 class="book-title">${bookData.title}</h2>
                    <button onclick="openBook('${bookData.path}')" class="read-button">Leer Ahora</button>
                </div>
            `;
            return card;
        }

        async function loadBookCover(bookData, bookCard) {
            try {
                const book = ePub(bookData.path);
                const coverUrl = await book.coverUrl();
                
                if (coverUrl) {
                    const coverContainer = bookCard.querySelector(`#cover-${bookData.id}`);
                    coverContainer.innerHTML = `<img src="${coverUrl}" alt="${bookData.title}" />`;
                }
            } catch (error) {
                console.error('Error al cargar la portada:', error);
            }
        }

        async function openBook(bookUrl) {
            const viewer = document.getElementById('bookViewer');
            const loadingEl = viewer.querySelector('.loading');
            
            viewer.classList.add('active');
            document.body.style.overflow = 'hidden';
            loadingEl.style.display = 'block';

            try {
                if (currentBook) {
                    currentBook.destroy();
                }

                currentBook = ePub(bookUrl);
                rendition = currentBook.renderTo("viewer", {
                    width: "100%",
                    height: "100%",
                    spread: "auto"
                });

                await rendition.display();
                
                // Configurar eventos de navegación
                rendition.on("keyup", handleKeyPress);
                rendition.on("relocated", (location) => {
                    // Aquí puedes agregar código para guardar el progreso
                    console.log('Ubicación actual:', location);
                });

            } catch (error) {
                console.error('Error al abrir el libro:', error);
                alert('Error al cargar el libro. Por favor, inténtalo de nuevo.');
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function closeViewer() {
            const viewer = document.getElementById('bookViewer');
            viewer.classList.remove('active');
            document.body.style.overflow = 'auto';

            if (currentBook) {
                currentBook.destroy();
                currentBook = null;
                rendition = null;
            }
            document.getElementById('viewer').innerHTML = '';
        }

        function handleKeyPress(e) {
            if (e.key === 'ArrowLeft') prevPage();
            if (e.key === 'ArrowRight') nextPage();
            if (e.key === 'Escape') closeViewer();
        }

        function prevPage() {
            if (rendition) {
                rendition.prev();
            }
        }

        function nextPage() {
            if (rendition) {
                rendition.next();
            }
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            loadBooks();
        });

        // Mantener el código del modo oscuro...
        // (El resto del código del modo oscuro se mantiene igual)
    </script>
</body>
</html>
